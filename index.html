<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Output Tracing App</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background-color:#f4f7f6;color:#333;display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;padding:1rem}
        .container{background-color:#fff;padding:2rem;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1);width:90%;max-width:500px}
        h1,h2{text-align:center;color:#0056b3;margin-bottom:1.5rem}
        h2{margin-top:2rem;font-size:1.2rem;border-top:1px solid #eee;padding-top:1.5rem}
        label{display:block;margin-top:1rem;margin-bottom:.5rem;font-weight:600}
        input[type="text"],input[type="file"],input[type="date"],input[type="password"]{width:100%;padding:.75rem;border:1px solid #ccc;border-radius:4px;box-sizing:border-box}
        button{cursor:pointer;transition:background-color .2s}
        .btn{width:100%;padding:.75rem;margin-top:1.5rem;background-color:#007bff;color:#fff;border:none;border-radius:4px;font-size:1rem}
        .btn:hover{background-color:#0056b3}
        #status,.results-div,#loginStatus{margin-top:1.5rem;padding:1rem;background-color:#e9ecef;border-radius:4px;text-align:center}
        .search-box{display:flex;gap:.5rem}
        .search-box input{flex-grow:1}
        .search-box .btn{margin-top:0;width:auto;padding:.75rem 1.5rem}
        .results-div ul{list-style-type:none;padding:0;text-align:left}
        .results-div li{padding:.75rem .5rem;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center;gap:1rem}
        .results-div li span{word-break:break-all;flex-grow:1}
        .results-div li a{text-decoration:none;color:#0056b3}
        .results-div li a:hover{text-decoration:underline}
        .action-btn-group{display:flex;gap:.5rem;flex-shrink:0}
        .rename-btn,.delete-btn{padding:.3rem .6rem;font-size:.8rem;color:#fff;border:none;border-radius:4px}
        .rename-btn{background-color:#6c757d}
        .rename-btn:hover{background-color:#5a6268}
        .delete-btn{background-color:#dc3545}
        .delete-btn:hover{background-color:#c82333}
        .hidden{display:none}
        #logoutBtn{background-color:#ffc107;color:#212529;margin-top:2rem}
        #logoutBtn:hover{background-color:#e0a800}
    </style>
</head>
<body>
    <div class="container">
        <div id="loginView">
            <h1>App Login</h1>
            <form id="loginForm">
                <label for="username">Username:</label>
                <input type="text" id="username" required>
                <label for="accessCode">Access Code:</label>
                <input type="password" id="accessCode" required>
                <button type="submit" class="btn">Login</button>
            </form>
            <div id="loginStatus"></div>
        </div>

        <div id="studentView" class="hidden">
            <h1>Submit Output</h1>
            <form id="uploadForm">
                <label for="section">Section:</label>
                <input type="text" id="section" placeholder="e.g., Newton" required>
                <label for="deadline">Deadline:</label>
                <input type="date" id="deadline" required>
                <label for="fileInput">Select File:</label>
                <input type="file" id="fileInput" required>
                <button type="submit" class="btn">Upload File</button>
            </form>
            <div id="status"></div>
            <h2>Manage Previous Submissions</h2>
            <div class="search-box">
                <input type="text" id="studentSearchInput" placeholder="Search your filename...">
                <button id="studentSearchButton" class="btn">Search</button>
            </div>
            <div id="studentResultsDiv" class="results-div"><p>Search for your file to manage it.</p></div>
            <button id="studentLogoutBtn" class="btn">Logout</button>
        </div>

        <div id="teacherView" class="hidden">
            <h1>Search Student Submissions</h1>
            <div class="search-box">
                <input type="text" id="teacherSearchInput" placeholder="Search by name, section...">
                <button id="teacherSearchButton" class="btn">Search</button>
            </div>
            <div id="teacherResultsDiv" class="results-div"><p>Enter a search term to find files.</p></div>
            <button id="teacherLogoutBtn" class="btn">Logout</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxVvaeW84Tsxa7p-JErcCohBpW3T9KOqwq9U0OqvYk6mHZ0153tI7TnLdzMz7DRP5Zp/exec';
        const MAX_SIZE_MB = 37.5;
        const MAX_SIZE_BYTES = MAX_SIZE_MB * 1024 * 1024;

        let session = { username: null, accessCode: null, role: null };

        const loginView = document.getElementById('loginView');
        const studentView = document.getElementById('studentView');
        const teacherView = document.getElementById('teacherView');
        const loginForm = document.getElementById('loginForm');
        const loginStatus = document.getElementById('loginStatus');

        function showView(viewId) {
            loginView.classList.add('hidden');
            studentView.classList.add('hidden');
            teacherView.classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
        }

        function logout() {
            session = { username: null, accessCode: null, role: null };
            document.querySelectorAll('form').forEach(form => form.reset());
            document.querySelectorAll('.results-div').forEach(div => div.innerHTML = '');
            showView('loginView');
        }

        document.getElementById('studentLogoutBtn').addEventListener('click', logout);
        document.getElementById('teacherLogoutBtn').addEventListener('click', logout);
        
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            loginStatus.textContent = 'Logging in...';
            const username = document.getElementById('username').value.trim();
            const accessCode = document.getElementById('accessCode').value.trim();
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'login', username, accessCode })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    session = { username, accessCode, role: data.role };
                    if (data.role === 'student') showView('studentView');
                    else if (data.role === 'teacher') showView('teacherView');
                    else loginStatus.textContent = 'Error: Unknown role.';
                } else {
                    loginStatus.textContent = `Error: ${data.message}`;
                }
            }).catch(err => loginStatus.textContent = `Network Error: ${err.message}`);
        });
        
        const uploadForm = document.getElementById('uploadForm');
        uploadForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const statusDiv = document.getElementById('status');
            const file = document.getElementById('fileInput').files[0];
            if (!file) { statusDiv.textContent = 'Please select a file.'; return; }
            if (file.size > MAX_SIZE_BYTES) { statusDiv.textContent = `Error: File exceeds ${MAX_SIZE_MB} MB.`; return; }

            statusDiv.textContent = 'Uploading...';
            const section = document.getElementById('section').value.trim().replace(/\s+/g, '_');
            const deadline = document.getElementById('deadline').value;
            const fileName = `${session.username}_${section}_${deadline}_${file.name}`;
            
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => {
                const payload = { ...session, action: 'upload', fileName, mimeType: file.type, fileData: reader.result };
                fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
                .then(res => res.json())
                .then(data => {
                    statusDiv.innerHTML = data.status === 'success' ? `✅ Uploaded: <strong>${data.fileName}</strong>` : `❌ Error: ${data.message}`;
                    if (data.status === 'success') uploadForm.reset();
                }).catch(err => statusDiv.textContent = `Network Error: ${err.message}`);
            };
        });

        function performSearch(searchTerm, resultsContainer, displayFunction) {
            if (!searchTerm) { resultsContainer.innerHTML = '<p>Please enter a search term.</p>'; return; }
            resultsContainer.innerHTML = '<p>Searching...</p>';
            const params = new URLSearchParams({ ...session, search: searchTerm });
            
            fetch(`${SCRIPT_URL}?${params.toString()}`)
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') displayFunction(data.files, resultsContainer);
                else resultsContainer.innerHTML = `<p>❌ Error: ${data.message}</p>`;
            }).catch(err => resultsContainer.innerHTML = `<p>❌ Network Error: ${err.message}</p>`);
        }

        document.getElementById('teacherSearchButton').addEventListener('click', () => {
            performSearch(document.getElementById('teacherSearchInput').value.trim(), document.getElementById('teacherResultsDiv'), displayTeacherResults);
        });

        document.getElementById('studentSearchButton').addEventListener('click', () => {
            performSearch(document.getElementById('studentSearchInput').value.trim(), document.getElementById('studentResultsDiv'), displayStudentResults);
        });
        
        function displayTeacherResults(files, container) {
            if (files.length === 0) { container.innerHTML = '<p>No files found.</p>'; return; }
            let html = '<ul>';
            files.forEach(f => { html += `<li><span><a href="${f.url}" target="_blank">${f.name}</a></span></li>`; });
            container.innerHTML = html + '</ul>';
        }

        function displayStudentResults(files, container) {
            if (files.length === 0) { container.innerHTML = '<p>No files found.</p>'; return; }
            let html = '<ul>';
            files.forEach(f => {
                html += `<li data-file-id="${f.id}" data-file-name="${f.name}">
                            <span><a href="${f.url}" target="_blank">${f.name}</a></span>
                            <div class="action-btn-group">
                                <button class="rename-btn">Rename</button>
                                <button class="delete-btn">Delete</button>
                            </div>
                         </li>`;
            });
            container.innerHTML = html + '</ul>';
        }

        document.getElementById('studentResultsDiv').addEventListener('click', function(e) {
            const target = e.target;
            const listItem = target.closest('li');
            if (!listItem) return;

            const fileId = listItem.dataset.fileId;
            const currentName = listItem.dataset.fileName;

            if (target.classList.contains('rename-btn')) {
                const newName = prompt("Enter new file name:", currentName);
                if (newName && newName.trim() !== '' && newName !== currentName) {
                    const payload = { ...session, action: 'rename', fileId, newName: newName.trim() };
                    fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            listItem.dataset.fileName = data.newName;
                            listItem.querySelector('span a').textContent = data.newName;
                            alert('File renamed!');
                        } else alert(`Error: ${data.message}`);
                    }).catch(err => alert(`Network Error: ${err.message}`));
                }
            } else if (target.classList.contains('delete-btn')) {
                if (confirm(`Are you sure you want to delete "${currentName}"?`)) {
                    const payload = { ...session, action: 'delete', fileId };
                    fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            listItem.remove();
                            alert('File deleted.');
                        } else alert(`Error: ${data.message}`);
                    }).catch(err => alert(`Network Error: ${err.message}`));
                }
            }
        });
    </script>
</body>
</html>
