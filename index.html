<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Output Tracing App</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background-color:#f4f7f6;color:#333;display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;padding:1rem}
        .container{background-color:#fff;padding:2rem;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1);width:90%;max-width:500px;position:relative}
        .back-button{position:absolute;top:1rem;left:1rem;font-size:1.5rem;text-decoration:none;color:#6c757d;transition:color .2s}
        .back-button:hover{color:#343a40}
        h1,h2{text-align:center;color:#0056b3;margin-bottom:1.5rem}
        h2{margin-top:2rem;font-size:1.2rem;border-top:1px solid #eee;padding-top:1.5rem}
        h2 span{color:#6c757d;font-weight:400}
        label{display:block;margin-top:1rem;margin-bottom:.5rem;font-weight:600}
        input[type="text"],input[type="file"],input[type="date"],input[type="password"],select{width:100%;padding:.75rem;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;background-color:#fff;font-size:1rem}
        button{cursor:pointer;transition:background-color .2s}
        .btn{width:100%;padding:.75rem;margin-top:1.5rem;background-color:#007bff;color:#fff;border:none;border-radius:4px;font-size:1rem}
        .btn:hover{background-color:#0056b3}
        #status,.results-div,#loginStatus{margin-top:1.5rem;padding:1rem;background-color:#e9ecef;border-radius:4px;text-align:center}
        .search-box{margin-top:1.5rem}
        .results-div ul{list-style-type:none;padding:0;text-align:left}
        .results-div li{padding:.75rem .5rem;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center;gap:1rem}
        .results-div li span{word-break:break-all;flex-grow:1}
        .results-div li a{text-decoration:none;color:#0056b3}
        .results-div li a:hover{text-decoration:underline}
        .action-btn-group{display:flex;gap:.5rem;flex-shrink:0}
        .rename-btn,.delete-btn{padding:.3rem .6rem;font-size:.8rem;color:#fff;border:none;border-radius:4px}
        .rename-btn{background-color:#6c757d}
        .rename-btn:hover{background-color:#5a6268}
        .delete-btn{background-color:#dc3545}
        .delete-btn:hover{background-color:#c82333}
        .hidden{display:none}
        #logoutBtn{background-color:#ffc107;color:#212529;margin-top:2rem}
        #logoutBtn:hover{background-color:#e0a800}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="container">
        <a href="https://cogonnationalhighschool.netlify.app/" class="back-button" title="Go Back">←</a>
        <div id="loginView">
            <h1>App Login</h1>
            <form id="loginForm">
                <label for="username">Username:</label>
                <input type="text" id="username" required>
                <label for="accessCode">Access Code:</label>
                <input type="password" id="accessCode" required>
                <button type="submit" class="btn">Login</button>
            </form>
            <div id="loginStatus"></div>
        </div>

        <div id="studentView" class="hidden">
            <h2>Welcome, <span id="studentUsername"></span></h2>
            <h1>Submit Output</h1>
            <form id="uploadForm">
                <label for="section">Section:</label>
                <select id="section" required>
                    <option value="" disabled selected>Select your section</option>
                    <option value="7 Diamond">7 Diamond</option>
                    <option value="7 Ruby">7 Ruby</option>
                    <option value="7 Pearl">7 Pearl</option>
                    <option value="8 Rose">8 Rose</option>
                    <option value="8 Sampaguita">8 Sampaguita</option>
                    <option value="8 Daisy">8 Daisy</option>
                    <option value="9 Narra">9 Narra</option>
                    <option value="9 Mahogany">9 Mahogany</option>
                    <option value="9 Molave">9 Molave</option>
                    <option value="10 Mangosteen">10 Mangosteen</option>
                    <option value="10 Durian">10 Durian</option>
                    <option value="10 Avocado">10 Avocado</option>
                    <option value="11 Unix ICT">11 Unix ICT</option>
                    <option value="11 Saturn HUMSS">11 Saturn HUMSS</option>
                    <option value="11 Bedaux ABM">11 Bedaux ABM</option>
                    <option value="11 Mecurry">11 Mecurry</option>
                    <option value="12 Blockchain ICT">12 Blockchain ICT</option>
                    <option value="12 Capricorn HE">12 Capricorn HE</option>
                    <option value="12 Bertalanffy ABM">12 Bertalanffy ABM</option>
                </select>
                <label for="deadline">Deadline:</label>
                <input type="date" id="deadline" required>
                <label for="fileInput">Select File:</label>
                <input type="file" id="fileInput" required>
                <button type="submit" class="btn">Upload File</button>
            </form>
            <div id="status" class="hidden"></div>
            <h2>Manage Previous Submissions</h2>
            <div class="search-box">
                <input type="text" id="studentSearchInput" placeholder="Filter your files by name...">
            </div>
            <div id="studentResultsDiv" class="results-div"><p>Your submitted files will appear here.</p></div>
            <button id="studentLogoutBtn" class="btn">Logout</button>
        </div>

        <div id="teacherView" class="hidden">
            <h2>Welcome, <span id="teacherUsername"></span></h2>
            <h1>Search Student Submissions</h1>
            <div class="search-box">
                <input type="text" id="teacherSearchInput" placeholder="Filter files by name, section, etc...">
            </div>
            <div id="teacherResultsDiv" class="results-div"><p>All submitted files will appear here.</p></div>
            <button id="teacherLogoutBtn" class="btn">Logout</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxVvaeW84Tsxa7p-JErcCohBpW3T9KOqwq9U0OqvYk6mHZ0153tI7TnLdzMz7DRP5Zp/exec';
        const MAX_SIZE_MB = 37.5;
        const MAX_SIZE_BYTES = MAX_SIZE_MB * 1024 * 1024;

        let session = { username: null, accessCode: null, role: null };
        let currentFiles = [];

        const loginView = document.getElementById('loginView');
        const studentView = document.getElementById('studentView');
        const teacherView = document.getElementById('teacherView');
        const loginForm = document.getElementById('loginForm');
        const loginStatus = document.getElementById('loginStatus');

        function showView(viewId) {
            loginView.classList.add('hidden');
            studentView.classList.add('hidden');
            teacherView.classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
        }

        function logout() {
            session = { username: null, accessCode: null, role: null };
            currentFiles = [];
            document.querySelectorAll('form').forEach(form => form.reset());
            document.querySelectorAll('.results-div').forEach(div => div.innerHTML = '');
            loginStatus.textContent = '';
            showView('loginView');
        }

        document.getElementById('studentLogoutBtn').addEventListener('click', logout);
        document.getElementById('teacherLogoutBtn').addEventListener('click', logout);
        
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            loginStatus.textContent = 'Logging in...';
            const username = document.getElementById('username').value.trim();
            const accessCode = document.getElementById('accessCode').value.trim();
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'login', username, accessCode })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    session = { username, accessCode, role: data.role };
                    if (data.role === 'student') {
                        document.getElementById('studentUsername').textContent = session.username;
                        showView('studentView');
                        performSearch('', document.getElementById('studentResultsDiv'), displayStudentResults);
                    } else if (data.role === 'teacher') {
                        document.getElementById('teacherUsername').textContent = session.username;
                        showView('teacherView');
                        performSearch('', document.getElementById('teacherResultsDiv'), displayTeacherResults);
                    }
                } else {
                    Swal.fire({ icon: 'error', title: 'Login Failed', text: data.message });
                    loginStatus.textContent = '';
                }
            }).catch(err => {
                Swal.fire({ icon: 'error', title: 'Network Error', text: err.message });
                loginStatus.textContent = '';
            });
        });
        
        const uploadForm = document.getElementById('uploadForm');
        uploadForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const file = document.getElementById('fileInput').files[0];
            const section = document.getElementById('section').value;
            
            if (!file) { Swal.fire('No File Selected', 'Please choose a file to upload.', 'warning'); return; }
            if (file.size > MAX_SIZE_BYTES) { Swal.fire('File Too Large', `Please choose a file smaller than ${MAX_SIZE_MB} MB.`, 'error'); return; }
            if (!section) { Swal.fire('No Section Selected', 'Please choose your section from the list.', 'warning'); return; }

            Swal.fire({
                title: 'Uploading...',
                text: 'Please wait while your file is uploaded.',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            const sectionFormatted = section.trim().replace(/\s+/g, '_');
            const deadline = document.getElementById('deadline').value;
            const fileName = `${session.username}_${sectionFormatted}_${deadline}_${file.name}`;
            
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => {
                const payload = { ...session, action: 'upload', fileName, mimeType: file.type, fileData: reader.result };
                fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        Swal.fire({ icon: 'success', title: 'Upload Complete!', text: `File "${data.fileName}" was uploaded successfully.` });
                        uploadForm.reset();
                        performSearch('', document.getElementById('studentResultsDiv'), displayStudentResults);
                    } else {
                        Swal.fire({ icon: 'error', title: 'Upload Failed', text: data.message });
                    }
                }).catch(err => Swal.fire({ icon: 'error', title: 'Network Error', text: err.message }));
            };
        });

        function performSearch(searchTerm, resultsContainer, displayFunction) {
            resultsContainer.innerHTML = '<p>Loading files...</p>';
            const params = new URLSearchParams({ ...session, search: searchTerm });
            
            fetch(`${SCRIPT_URL}?${params.toString()}`)
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    currentFiles = data.files;
                    displayFunction(currentFiles, resultsContainer);
                } else {
                     resultsContainer.innerHTML = `<p>❌ Error: ${data.message}</p>`;
                }
            }).catch(err => resultsContainer.innerHTML = `<p>❌ Network Error: ${err.message}</p>`);
        }
        
        document.getElementById('teacherSearchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredFiles = currentFiles.filter(file => file.name.toLowerCase().includes(searchTerm));
            displayTeacherResults(filteredFiles, document.getElementById('teacherResultsDiv'));
        });
        
        document.getElementById('studentSearchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredFiles = currentFiles.filter(file => file.name.toLowerCase().includes(searchTerm));
            displayStudentResults(filteredFiles, document.getElementById('studentResultsDiv'));
        });

        function displayTeacherResults(files, container) {
            if (files.length === 0) { container.innerHTML = '<p>No files found.</p>'; return; }
            let html = '<ul>';
            files.forEach(f => { html += `<li><span><a href="${f.url}" target="_blank">${f.name}</a></span></li>`; });
            container.innerHTML = html + '</ul>';
        }

        function displayStudentResults(files, container) {
            if (files.length === 0) { container.innerHTML = '<p>No files found.</p>'; return; }
            let html = '<ul>';
            files.forEach(f => {
                html += `<li data-file-id="${f.id}" data-file-name="${f.name}">
                            <span><a href="${f.url}" target="_blank">${f.name}</a></span>
                            <div class="action-btn-group">
                                <button class="rename-btn">Rename</button>
                                <button class="delete-btn">Delete</button>
                            </div>
                         </li>`;
            });
            container.innerHTML = html + '</ul>';
        }

        document.getElementById('studentResultsDiv').addEventListener('click', function(e) {
            const target = e.target;
            const listItem = target.closest('li');
            if (!listItem) return;

            const fileId = listItem.dataset.fileId;
            const currentName = listItem.dataset.fileName;

            if (target.classList.contains('rename-btn')) {
                Swal.fire({
                    title: 'Enter New File Name',
                    input: 'text',
                    inputValue: currentName,
                    showCancelButton: true,
                    confirmButtonText: 'Rename',
                    inputValidator: (value) => {
                        if (!value || value.trim() === '') { return 'You need to write something!'; }
                        if (value === currentName) { return 'Please enter a different name.'; }
                    }
                }).then(result => {
                    if (result.isConfirmed) {
                        const newName = result.value.trim();
                        const payload = { ...session, action: 'rename', fileId, newName };
                        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 'success') {
                                Swal.fire('Renamed!', 'Your file has been renamed.', 'success');
                                performSearch('', document.getElementById('studentResultsDiv'), displayStudentResults);
                            } else {
                                Swal.fire('Error!', data.message, 'error');
                            }
                        }).catch(err => Swal.fire('Network Error', err.message, 'error'));
                    }
                });
            } else if (target.classList.contains('delete-btn')) {
                Swal.fire({
                    title: 'Are you sure?',
                    text: `You are about to delete "${currentName}". You won't be able to revert this!`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const payload = { ...session, action: 'delete', fileId };
                        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 'success') {
                                Swal.fire('Deleted!', 'Your file has been deleted.', 'success');
                                performSearch('', document.getElementById('studentResultsDiv'), displayStudentResults);
                            } else {
                                Swal.fire('Error!', data.message, 'error');
                            }
                        }).catch(err => Swal.fire('Network Error', err.message, 'error'));
                    }
                });
            }
        });
    </script>
</body>
</html>
